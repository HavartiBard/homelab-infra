---
# Using raw/shell commands since Unraid lacks Python

- name: Create appdata directory
  ansible.builtin.raw: mkdir -p {{ portainer_mcp_appdata_dir }}
  changed_when: false

- name: Pull container image
  ansible.builtin.raw: docker pull {{ portainer_mcp_image }}
  register: pull_result
  changed_when: "'Downloaded newer image' in pull_result.stdout or 'Pull complete' in pull_result.stdout"

- name: Stop existing container (if running)
  ansible.builtin.raw: docker stop {{ portainer_mcp_container_name }} 2>/dev/null || true
  changed_when: false

- name: Remove existing container (if exists)
  ansible.builtin.raw: docker rm {{ portainer_mcp_container_name }} 2>/dev/null || true
  changed_when: false

- name: Deploy portainer-mcp container
  ansible.builtin.raw: |
    docker run -d \
      --name {{ portainer_mcp_container_name }} \
      --restart unless-stopped \
      -p {{ portainer_mcp_port }}:{{ portainer_mcp_port }} \
      -e TZ={{ timezone }} \
      {{ portainer_mcp_image }} \
      -server "{{ portainer_server }}" \
      -token "{{ portainer_token }}" \
      -transport "{{ portainer_mcp_transport }}" \
      -port {{ portainer_mcp_port }} \
      -disable-version-check
  register: deploy_result
  changed_when: true

- name: Wait for container to start
  ansible.builtin.raw: sleep 5
  changed_when: false

- name: Check container is running
  ansible.builtin.raw: docker ps --filter "name={{ portainer_mcp_container_name }}" --filter "status=running" -q
  register: container_check
  failed_when: container_check.stdout | trim == ""
  changed_when: false

- name: Get container logs
  ansible.builtin.raw: docker logs --tail 10 {{ portainer_mcp_container_name }}
  register: container_logs
  changed_when: false

- name: Display container logs
  ansible.builtin.debug:
    msg: "{{ container_logs.stdout_lines }}"
