---
# Deploy Unraid MCP Server container
# Uses raw commands since Unraid lacks Python

- name: Check Docker daemon and network connectivity
  ansible.builtin.raw: |
    docker --version
    echo "Testing connectivity to GHCR..."
    timeout 10 curl -I https://ghcr.io 2>/dev/null | head -1 || echo "Cannot reach GHCR"
  register: connectivity_check
  changed_when: false

- name: Display connectivity check
  ansible.builtin.debug:
    msg: "{{ connectivity_check.stdout_lines }}"

- name: Pull container image
  ansible.builtin.raw: |
    timeout 60 docker pull {{ unraid_mcp_image }}
  register: pull_result
  changed_when: pull_result.stdout is search('Downloaded newer image') or pull_result.stdout is search('Pulling from') or pull_result.stdout is search('Image is up to date')

- name: Stop existing container (if running)
  ansible.builtin.raw: |
    docker stop {{ unraid_mcp_container_name }} 2>/dev/null || true
  changed_when: false

- name: Remove existing container (if exists)
  ansible.builtin.raw: |
    docker rm {{ unraid_mcp_container_name }} 2>/dev/null || true
  changed_when: false

- name: Deploy unraid-mcp container
  ansible.builtin.raw: |
    docker run -d \
      --name {{ unraid_mcp_container_name }} \
      --restart unless-stopped \
      -p {{ unraid_mcp_port }}:{{ unraid_mcp_port }} \
      -e UNRAID_API_URL='{{ unraid_api_url }}' \
      -e UNRAID_API_KEY='{{ unraid_api_key }}' \
      -e UNRAID_MCP_PORT='{{ unraid_mcp_port }}' \
      -e UNRAID_MCP_HOST='{{ unraid_mcp_host }}' \
      -e UNRAID_MCP_TRANSPORT='{{ unraid_mcp_transport }}' \
      -e UNRAID_VERIFY_SSL='{{ unraid_verify_ssl | lower }}' \
      -e UNRAID_MCP_LOG_LEVEL='{{ unraid_mcp_log_level }}' \
      -e UNRAID_AUTO_START_SUBSCRIPTIONS='{{ unraid_auto_start_subscriptions | lower }}' \
      -e TZ='{{ timezone }}' \
      {{ unraid_mcp_image }}
  register: container_result
  changed_when: container_result.rc == 0

- name: Wait for container to start
  ansible.builtin.raw: |
    sleep 3
  changed_when: false

- name: Check container is running
  ansible.builtin.raw: |
    docker ps --filter "name={{ unraid_mcp_container_name }}" --filter "status=running" -q
  register: running_check
  failed_when: running_check.stdout | trim == ""
  changed_when: false

- name: Get container logs
  ansible.builtin.raw: |
    docker logs --tail 10 {{ unraid_mcp_container_name }} 2>&1
  register: container_logs
  changed_when: false

- name: Display container logs
  ansible.builtin.debug:
    msg: "{{ container_logs.stdout_lines }}"
