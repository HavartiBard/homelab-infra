---
# Deploy 1Password MCP Server to Unraid
#
# Usage:
#   export OP_SERVICE_ACCOUNT_TOKEN='<from 1Password>'
#   ansible-playbook playbooks/deploy-onepassword-mcp.yml

- name: Deploy 1Password MCP to Unraid
  hosts: unraid
  gather_facts: false

  vars:
    op_service_account_token: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

  pre_tasks:
    - name: Verify OP_SERVICE_ACCOUNT_TOKEN is set
      ansible.builtin.fail:
        msg: "OP_SERVICE_ACCOUNT_TOKEN environment variable must be set"
      when: op_service_account_token | length == 0

  roles:
    - role: onepassword-mcp
      vars:
        op_service_account_token: "{{ op_service_account_token }}"

  post_tasks:
    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          1Password MCP deployed successfully!
          Endpoint: http://{{ ansible_host }}:6975/mcp
